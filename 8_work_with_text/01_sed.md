# Работа с текстом: команда sed

## Введение

`sed` (Stream EDitor) - это мощный потоковый текстовый редактор, который позволяет выполнять различные операции с текстом. В этом уроке мы рассмотрим основные возможности sed.

## Основы работы с sed

### Базовый синтаксис

```bash
#!/bin/bash

# Базовый синтаксис sed
sed 'команда' файл

# Пример замены текста
sed 's/старый/новый/' input.txt

# Замена с сохранением в файл
sed 's/старый/новый/' input.txt > output.txt
```

### Работа со стандартным вводом

```bash
#!/bin/bash

# Чтение из stdin
echo "текст" | sed 's/текст/новый текст/'

# Чтение из файла
cat input.txt | sed 's/старый/новый/'
```

## Выполнение наборов команд при вызове sed

### Несколько команд

```bash
#!/bin/bash

# Выполнение нескольких команд
sed -e 's/первый/1/' -e 's/второй/2/' input.txt

# Использование точки с запятой
sed 's/первый/1/; s/второй/2/' input.txt
```

### Команды в файле

```bash
#!/bin/bash

# Создание файла с командами
cat > commands.sed << EOF
s/старый/новый/
s/текст/слова/
p
EOF

# Применение команд из файла
sed -f commands.sed input.txt
```

## Флаги команды замены

### Основные флаги

```bash
#!/bin/bash

# Замена всех вхождений (g)
sed 's/старый/новый/g' input.txt

# Вывод только измененных строк (p)
sed -n 's/старый/новый/p' input.txt

# Игнорирование регистра (i)
sed 's/старый/новый/i' input.txt

# Замена только n-го вхождения
sed 's/старый/новый/2' input.txt
```

### Комбинирование флагов

```bash
#!/bin/bash

# Комбинация флагов
sed 's/старый/новый/gi' input.txt  # глобально, игнорировать регистр
sed -n 's/старый/новый/gp' input.txt  # глобально, выводить только измененные
```

## Символы-разделители

### Использование разных разделителей

```bash
#!/bin/bash

# Стандартный разделитель /
sed 's/текст/новый текст/' input.txt

# Использование других разделителей
sed 's#текст#новый текст#' input.txt
sed 's|текст|новый текст|' input.txt
sed 's:текст:новый текст:' input.txt
```

### Работа со сложными строками

```bash
#!/bin/bash

# Замена путей
sed 's#/old/path#/new/path#' input.txt

# Замена с использованием |
sed 's|http://|https://|' input.txt
```

## Выбор фрагментов текста для обработки

### По номерам строк

```bash
#!/bin/bash

# Обработка определенных строк
sed '1,5s/старый/новый/' input.txt  # строки 1-5
sed '5,$s/старый/новый/' input.txt  # с 5-й строки до конца
sed '1~2s/старый/новый/' input.txt  # каждая вторая строка
```

### По шаблону

```bash
#!/bin/bash

# Обработка строк по шаблону
sed '/шаблон/s/старый/новый/' input.txt

# Обработка диапазона между шаблонами
sed '/начало/,/конец/s/старый/новый/' input.txt
```

## Удаление строк

### Базовое удаление

```bash
#!/bin/bash

# Удаление строк по номеру
sed '5d' input.txt

# Удаление диапазона строк
sed '1,5d' input.txt

# Удаление последней строки
sed '$d' input.txt
```

### Удаление по шаблону

```bash
#!/bin/bash

# Удаление строк по шаблону
sed '/шаблон/d' input.txt

# Удаление пустых строк
sed '/^$/d' input.txt

# Удаление строк с комментариями
sed '/^#/d' input.txt
```

## Вставка текста в поток

### Вставка строк

```bash
#!/bin/bash

# Вставка перед строкой
sed '5i\новая строка' input.txt

# Вставка после строки
sed '5a\новая строка' input.txt

# Вставка в начало файла
sed '1i\первая строка' input.txt
```

### Вставка блока текста

```bash
#!/bin/bash

# Вставка блока текста
sed '5i\
строка 1\
строка 2\
строка 3' input.txt
```

## Замена строк

### Полная замена строк

```bash
#!/bin/bash

# Замена строки по номеру
sed '5c\новая строка' input.txt

# Замена диапазона строк
sed '1,5c\новый блок текста' input.txt
```

### Замена по шаблону

```bash
#!/bin/bash

# Замена строки по шаблону
sed '/шаблон/c\новая строка' input.txt

# Замена с сохранением части строки
sed 's/\(.*\)старый\(.*\)/\1новый\2/' input.txt
```

## Замена символов

### Транслитерация

```bash
#!/bin/bash

# Замена символов
sed 'y/абв/АБВ/' input.txt

# Замена нескольких символов
sed 'y/abcdef/ABCDEF/' input.txt
```

### Удаление символов

```bash
#!/bin/bash

# Удаление определенных символов
sed 's/[[:punct:]]//g' input.txt

# Удаление пробелов
sed 's/[[:space:]]//g' input.txt
```

## Вывод номеров строк

### Нумерация строк

```bash
#!/bin/bash

# Добавление номеров строк
sed '=' input.txt

# Нумерация только непустых строк
sed '/./=' input.txt

# Нумерация с форматированием
sed '=' input.txt | sed 'N;s/\n/\t/'
```

## Чтение данных для вставки из файла

### Вставка из файла

```bash
#!/bin/bash

# Вставка содержимого файла
sed '5r insert.txt' input.txt

# Вставка после шаблона
sed '/шаблон/r insert.txt' input.txt
```

## Практическое задание

Создайте скрипт `sed_demo.sh`:

```bash
#!/bin/bash

# Создание тестового файла
cat > test.txt << EOF
Это старый текст
Это тоже старый текст
# Это комментарий
Это новый текст
Это пустая строка

Это последняя строка
EOF

echo "=== Исходный файл ==="
cat test.txt

echo -e "\n=== Замена текста ==="
sed 's/старый/новый/g' test.txt

echo -e "\n=== Удаление комментариев ==="
sed '/^#/d' test.txt

echo -e "\n=== Удаление пустых строк ==="
sed '/^$/d' test.txt

echo -e "\n=== Нумерация строк ==="
sed '=' test.txt | sed 'N;s/\n/\t/'

echo -e "\n=== Вставка текста ==="
sed '3i\Это вставленная строка' test.txt

echo -e "\n=== Замена разделителей ==="
echo "path/to/file" | sed 's#/#\\#g'
```

## Важные моменты

- sed работает с потоком данных
- Команды выполняются последовательно
- Можно комбинировать команды
- Используйте флаг -i для изменения файла на месте
- Проверяйте результат перед применением

## Дополнительные материалы

- [Sed Manual](https://www.gnu.org/software/sed/manual/sed.html)
- [Sed One-Liners](http://sed.sourceforge.net/sed1line.txt)

## Вопросы для самопроверки

1. Как выполнить замену текста в файле?
2. Как удалить определенные строки?
3. Как вставить текст в определенное место?
4. Как нумеровать строки?
5. Как работать с разными разделителями в sed? 